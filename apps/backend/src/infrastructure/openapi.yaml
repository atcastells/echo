openapi: 3.1.0
info:
  title: Jura API
  description: Backend API for the Jura application
  version: 1.0.0
  contact:
    name: API Support
servers:
  - url: http://localhost:3000
    description: Development server
  - url: https://api.jura.com
    description: Production server

tags:
  - name: Health
    description: Health check endpoints
  - name: Auth
    description: Authentication endpoints
  - name: AI
    description: AI and agent-related endpoints
  - name: Documents
    description: Document ingestion and management endpoints
  - name: Agents
    description: Agent configuration and management endpoints
  - name: Profile
    description: User profile management endpoints

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns the current health status of the API
      operationId: getHealth
      responses:
        "200":
          description: API is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time
                    example: "2025-12-12T14:00:00.000Z"

  /auth/signup:
    post:
      tags:
        - Auth
      summary: User Signup
      description: Register a new user with email and password. Organization ID is generated server-side.
      operationId: authSignup
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: securePassword123
      responses:
        "201":
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          description: Bad request (e.g. user exists)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /auth/signin:
    post:
      tags:
        - Auth
      summary: User Signin
      description: Authenticate user via email and password to receive a JWT token.
      operationId: authSignin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: securePassword123
      responses:
        "200":
          description: Authenticated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /auth/me:
    get:
      tags:
        - Auth
      summary: Get Current User
      description: Retrieve details of the currently authenticated user.
      operationId: authMe
      security:
        - bearerAuth: []
      responses:
        "200":
          description: User details retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/v1/ingest:
    post:
      tags:
        - Documents
      summary: Upload Document
      description: Upload a document (PDF) for ingestion.
      operationId: ingestDocument
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
                  description: PDF file to upload (max 10MB)
      responses:
        "200":
          description: File uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  file:
                    type: object
                    properties:
                      originalName:
                        type: string
                      mimeType:
                        type: string
                      size:
                        type: number
                      url:
                        type: string
        "400":
          description: Bad request (invalid file type or size)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    get:
      tags:
        - Documents
      summary: List Documents
      description: Retrieve a list of uploaded documents.
      operationId: listDocuments
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of documents
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Document"
        "401":
          description: Unauthorized

  /api/v1/ingest/{id}:
    delete:
      tags:
        - Documents
      summary: Delete Document
      description: Delete a specific document by ID.
      operationId: deleteDocument
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Document ID
      responses:
        "200":
          description: Document deleted successfully
        "404":
          description: Document not found
        "401":
          description: Unauthorized

  /api/v1/agents:
    get:
      tags:
        - Agents
      summary: List Agents
      description: List all agents configured for the current user.
      operationId: listAgents
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of agents
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Agent"
        "401":
          description: Unauthorized
    post:
      tags:
        - Agents
      summary: Create Agent
      description: Create a new agent configuration.
      operationId: createAgent
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateAgentRequest"
      responses:
        "201":
          description: Agent created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Agent"
        "400":
          description: Bad Request
        "401":
          description: Unauthorized

  /api/v1/agents/{id}:
    get:
      tags:
        - Agents
      summary: Get Agent
      description: Retrieve details of a specific agent.
      operationId: getAgent
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Application specific Agent ID
      responses:
        "200":
          description: Agent details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Agent"
        "404":
          description: Agent not found
        "401":
          description: Unauthorized

  /api/v1/agents/{id}/chat:
    post:
      tags:
        - Agents
      summary: Chat with Agent
      description: Send a message to the agent and get a response based on its configuration and RAG context.
      operationId: chatWithAgent
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Application specific Agent ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChatRequest"
      responses:
        "200":
          description: Agent response
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    description: The agent's reply
        "400":
          description: Bad Request
        "401":
          description: Unauthorized
        "403":
          description: Forbidden (Private agent)
        "404":
          description: Agent not found

  /api/v1/agents/{id}/threads:
    post:
      tags:
        - Agents
      summary: Create Thread
      description: Create a new conversation thread for stateful chat with an agent.
      operationId: createThread
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Agent ID
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                  description: Optional title for the thread
      responses:
        "201":
          description: Thread created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Thread"
        "400":
          description: Bad Request
        "401":
          description: Unauthorized
        "403":
          description: Forbidden (Threading disabled or private agent)
        "404":
          description: Agent not found
    get:
      tags:
        - Agents
      summary: List Threads
      description: List all conversation threads for a specific agent.
      operationId: listThreads
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Agent ID
      responses:
        "200":
          description: List of threads
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Thread"
        "401":
          description: Unauthorized

  /api/v1/agents/{id}/threads/{threadId}:
    get:
      tags:
        - Agents
      summary: Get Thread History
      description: Retrieve the complete message history for a conversation thread.
      operationId: getThreadHistory
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Agent ID
        - in: path
          name: threadId
          required: true
          schema:
            type: string
          description: Thread ID
      responses:
        "200":
          description: Thread message history
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ChatMessage"
        "401":
          description: Unauthorized
        "403":
          description: Forbidden (Unauthorized access to thread)
        "404":
          description: Thread not found

  /api/v1/profile/me:
    get:
      tags:
        - Profile
      summary: Get My Profile
      description: Retrieve the current user's profile. Creates a new profile if one doesn't exist.
      operationId: getMyProfile
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Profile"
        "401":
          description: Unauthorized

    patch:
      tags:
        - Profile
      summary: Update My Profile
      description: Update top-level profile fields (basics, summary, skills, preferences).
      operationId: updateMyProfile
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateProfileRequest"
      responses:
        "200":
          description: Profile updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Profile"
        "400":
          description: Bad request (validation error)
        "401":
          description: Unauthorized
        "404":
          description: Profile not found

  /api/v1/profile/me/roles:
    post:
      tags:
        - Profile
      summary: Add Role
      description: Add a new work role/experience to the profile.
      operationId: addRole
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AddRoleRequest"
      responses:
        "201":
          description: Role added successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Profile"
        "400":
          description: Bad request (validation error)
        "401":
          description: Unauthorized
        "404":
          description: Profile not found

  /api/v1/profile/me/roles/{roleId}:
    patch:
      tags:
        - Profile
      summary: Update Role
      description: Update an existing work role/experience.
      operationId: updateRole
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: roleId
          required: true
          schema:
            type: string
          description: Role ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateRoleRequest"
      responses:
        "200":
          description: Role updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Profile"
        "400":
          description: Bad request (validation error)
        "401":
          description: Unauthorized
        "404":
          description: Profile or role not found

    delete:
      tags:
        - Profile
      summary: Delete Role
      description: Delete a work role/experience from the profile.
      operationId: deleteRole
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: roleId
          required: true
          schema:
            type: string
          description: Role ID
      responses:
        "200":
          description: Role deleted successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Profile"
        "401":
          description: Unauthorized
        "404":
          description: Profile or role not found

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          description: User ID (MongoDB ObjectId)
        email:
          type: string
          format: email
        organizationId:
          type: string
          description: Tenant Organization ID
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    AuthResponse:
      type: object
      properties:
        token:
          type: string
          description: JWT Access Token
        user:
          $ref: "#/components/schemas/User"

    Error:
      type: object
      properties:
        message:
          type: string
          description: Error message
        code:
          type: string
          description: Error code
      required:
        - message

    Document:
      type: object
      properties:
        id:
          type: string
        originalName:
          type: string
        mimeType:
          type: string
        size:
          type: number
        publicUrl:
          type: string
        category:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Agent:
      type: object
      properties:
        id:
          type: string
        userId:
          type: string
        name:
          type: string
        type:
          type: string
          enum: [PRIVATE, PUBLIC]
        status:
          type: string
          enum: [ACTIVE, ARCHIVED]
        configuration:
          type: object
          properties:
            systemPrompt:
              type: string
            tone:
              type: string
            enableThreads:
              type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreateAgentRequest:
      type: object
      required:
        - name
        - type
        - instructions
        - tone
      properties:
        name:
          type: string
        type:
          type: string
          enum: [PRIVATE, PUBLIC]
        instructions:
          type: string
          description: Base system prompt/instructions for the agent
        tone:
          type: string
          description: Voice tone (e.g., Professional, Casual)
        enableThreads:
          type: boolean
          description: Enable persistent chat history (default false)
          default: false

    ChatRequest:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: User's message to the agent
        threadId:
          type: string
          description: Optional Thread ID for stateful chat

    Thread:
      type: object
      properties:
        id:
          type: string
        agentId:
          type: string
        title:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ChatMessage:
      type: object
      properties:
        id:
          type: string
        role:
          type: string
          enum: [user, assistant]
          description: |
            Role of the message sender. Only 'user' and 'assistant' are returned via the API.
            The 'system' role exists internally but is never returned to API consumers.
        content:
          type: string
        createdAt:
          type: string
          format: date-time

    Profile:
      type: object
      properties:
        id:
          type: string
        userId:
          type: string
        basics:
          $ref: "#/components/schemas/ProfileBasics"
        summary:
          type: string
        roles:
          type: array
          items:
            $ref: "#/components/schemas/ProfileRole"
        projects:
          type: array
          items:
            $ref: "#/components/schemas/ProfileProject"
        education:
          type: array
          items:
            $ref: "#/components/schemas/ProfileEducation"
        certifications:
          type: array
          items:
            $ref: "#/components/schemas/ProfileCertification"
        achievements:
          type: array
          items:
            $ref: "#/components/schemas/ProfileAchievement"
        skills:
          type: array
          items:
            type: string
        languages:
          type: array
          items:
            $ref: "#/components/schemas/ProfileLanguage"
        preferences:
          $ref: "#/components/schemas/ProfilePreferences"
        completenessScore:
          type: number
          description: Profile completeness score (0-100)
        evidence:
          type: array
          items:
            $ref: "#/components/schemas/ProfileEvidence"
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ProfileBasics:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
        phone:
          type: string
        name:
          type: string
        location:
          type: string
        linkedIn:
          type: string
        github:
          type: string
        website:
          type: string

    ProfileRole:
      type: object
      required:
        - id
        - title
        - highlights
      properties:
        id:
          type: string
        title:
          type: string
        company:
          type: string
        location:
          type: string
        startDate:
          type: string
        endDate:
          type: string
        current:
          type: boolean
        description:
          type: string
        highlights:
          type: array
          items:
            type: string

    ProfileProject:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        url:
          type: string
        startDate:
          type: string
        endDate:
          type: string
        technologies:
          type: array
          items:
            type: string

    ProfileEducation:
      type: object
      required:
        - id
        - institution
      properties:
        id:
          type: string
        institution:
          type: string
        degree:
          type: string
        field:
          type: string
        startDate:
          type: string
        endDate:
          type: string
        description:
          type: string

    ProfileCertification:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: string
        name:
          type: string
        issuer:
          type: string
        issueDate:
          type: string
        expiryDate:
          type: string
        credentialId:
          type: string
        url:
          type: string

    ProfileAchievement:
      type: object
      required:
        - id
        - title
      properties:
        id:
          type: string
        title:
          type: string
        description:
          type: string
        date:
          type: string

    ProfileLanguage:
      type: object
      required:
        - language
      properties:
        language:
          type: string
        proficiency:
          type: string

    ProfilePreferences:
      type: object
      properties:
        lookingForWork:
          type: boolean
        preferredRoles:
          type: array
          items:
            type: string
        preferredLocations:
          type: array
          items:
            type: string
        remoteOnly:
          type: boolean
        salaryExpectation:
          type: string

    ProfileEvidence:
      type: object
      required:
        - fieldPath
        - source
        - confidence
      properties:
        fieldPath:
          type: string
        source:
          type: string
        confidence:
          type: number

    UpdateProfileRequest:
      type: object
      properties:
        basics:
          type: object
          properties:
            email:
              type: string
              format: email
            phone:
              type: string
            name:
              type: string
            location:
              type: string
            linkedIn:
              type: string
            github:
              type: string
            website:
              type: string
        summary:
          type: string
        skills:
          type: array
          items:
            type: string
        preferences:
          type: object
          properties:
            lookingForWork:
              type: boolean
            preferredRoles:
              type: array
              items:
                type: string
            preferredLocations:
              type: array
              items:
                type: string
            remoteOnly:
              type: boolean
            salaryExpectation:
              type: string

    AddRoleRequest:
      type: object
      required:
        - title
        - highlights
      properties:
        title:
          type: string
        company:
          type: string
        location:
          type: string
        startDate:
          type: string
        endDate:
          type: string
        current:
          type: boolean
        description:
          type: string
        highlights:
          type: array
          items:
            type: string

    UpdateRoleRequest:
      type: object
      properties:
        title:
          type: string
        company:
          type: string
        location:
          type: string
        startDate:
          type: string
        endDate:
          type: string
        current:
          type: boolean
        description:
          type: string
        highlights:
          type: array
          items:
            type: string
